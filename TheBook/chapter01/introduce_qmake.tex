%使用xelatex编译
%版权所有，翻版必究
%本文件由程序自动生成，任何修改将被覆盖





%


\subsection{
qmake入门
}\label{s100310}


qmake类似于cmake，但qmake比cmake更加简洁清晰。
如果读者希望写一个跨平台的库的话，
或许cmake是比qmake更加优异的选择。
但读者明确是写一个特定的应用程序的话，
qmake就比cmake优秀的多。
qmake比cmake确实功能较少，
但从另一个角度，
qmake比cmake更加专注。
通过本节，
读者会发现只需要学习可怜的一点内容，
就可以使用qmake搭建出复杂的程序架构。

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{
使用qmake构建Hellow World！
}\label{ss000610}

读者新建一个目录\footnote{
本书所有目录都要求不包含空格和中文，以后不再赘述。
}，
在此文件夹下新建一个“hellow\underline{\hspace{0.5em}}world.pro”文件，输入文件内容如
\lstlistingname\ \ref{f000002}。
在此文件夹下建立“main.cpp”文件，输入内容如
\lstlistingname\ \ref{f000003}。

\begin{lstlisting}[label=f000002,
caption=GoodLuck,
title=\lstlistingname\ \thelstlisting
]
QT -= gui
QT -= core

CONFIG += console

CONFIG(debug,debug|release){
    TARGET = hellow_word_debug
}else{
    TARGET = hellow_word
}

TEMPLATE = app

win32-msvc*{
    QMAKE_CXXFLAGS += /std:c++latest
}else{
    CONFIG += c++17
}

SOURCES += $$PWD/main.cpp
DESTDIR =  $$PWD

DEFINES *= NUMBER=1
DEFINES *= HELLOW=\\\"Hellow\\\"
DEFINES += QT_DEPRECATED_WARNINGS
\end{lstlisting}          %抄录环境

\begin{lstlisting}[label=f000003,
caption=GoodLuck,
title=\lstlistingname\ \thelstlisting
]
#include <iostream>

int main(int , char **) {
    if constexpr(NUMBER) {
        std::cout << HELLOW " World! "
                  << std::endl;
    }
}
\end{lstlisting}          %抄录环境


使用QtCreator打开“hellow\underline{\hspace{0.5em}}world.pro”，
运行此项目。

现在来分析一下\lstlistingname\ \ref{f000002}：
\begin{itemize}
\item 第1\~{}2行表示不使用Qt库；
\item 第4行表示这是一个控制台应用程序；
\item 第6\~{}10行表示在debug模式下输出目标名称是“hellow\underline{\hspace{0.5em}}world\underline{\hspace{0.5em}}debug”，
在release模式下输出目标名称是“hellow\underline{\hspace{0.5em}}world”；
\item 第12行表示输出的是一个应用程序；
\item 第14\~{}18行表示使用C++17标准；
\item 第20行将“main.cpp”加入编译过程；
\item 第21行规定输出目录就是当前“pro”文件所在目录；
\item 第23行定义了一个叫“NUMBER”的宏，宏的值是一个数字；
\item 第24行定义了一个叫“HELLOW”的宏，宏的值是一个字符串；
\item 第25行定义了一个叫“QT\underline{\hspace{0.5em}}DEPRECATED\underline{\hspace{0.5em}}WARNINGS”的宏，这个宏没有定义值；
\end{itemize}

不难发现qmake的语法十分简单：
\begin{itemize}
\item “=”代表赋值；
\item “+=”代表向变量中增加元素；
\item “-=”代表从变量中删除元素；
\item “*=”代表如果变量中不存在则加入元素否则忽略；
\item “\~{}=”代表替换变量中的值；
\item “\$\$”代表当qmake运行时，变量的字面值；
\item “\$”代表当qmake生成Makefile后，变量的字面值；
\item “\#”代表注释；
\item “SOURCES”代表需要编译的C/C++源代码对象；
\item “HEADERS”代表C/C++头文件对象；
\item “DEFINES”代表C/C++宏对象；
\item “TARGET”代表输出对象名称；
\item “CONFIG”用来加入和检查Qt中预定义的编译选项；
\item “QMAKE\underline{\hspace{0.5em}}CXXFLAGS”代表qmake生成Makefile时需要加入的编译器参数；
\item “TEMPLATE”决定此项目的模板类型，本案例是使用应用程序模板（app）后续章节会介绍更多模板；
\end{itemize}

第6\~{}10行和14\~{}18虽然写法不同，实际上都是检查“CONFIG”中是否定义了特定项。
读者可以尝试一下向文件“hellow\underline{\hspace{0.5em}}world.pro”文件最后
加入\lstlistingname\ \ref{f00000d}，
分别去掉\lstlistingname\ \ref{f00000d}第一行和
保留第一行qtcreator的“概要信息”输出什么。
\begin{lstlisting}[label=f00000d,
caption=GoodLuck,
title=\lstlistingname\ \thelstlisting
]
CONFIG += mydebug
mydebug{
    message("find my debug")
}else{
    message("can not find my debug")
}
\end{lstlisting}          %抄录环境




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{
使用qmake创建动态链接库
}\label{ss000710}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{
qmake高级用法
}\label{ss000810}


\stepcounter{treeIndexNumber}%增加目录树编号
\begin{lstlisting}[label=d000000,
numbers=none,
title=\theTreeIndexNumber
]
.
├── advance_use_qmake.pro
├── after_run
│   ├── after_run.pro
│   └── main.cpp
├── before_run
│   ├── before_run.pro
│   └── main.cpp
├── new_moc
│   ├── main.cpp
│   └── new_moc.pro
└── the_run
    ├── main.cpp
    ├── test1.hpp
    ├── test2.hpp
    └── the_run.pro
\end{lstlisting}          %抄录环境


\begin{lstlisting}[label=f000004,
caption=GoodLuck,
title=\lstlistingname\ \thelstlisting
]
TEMPLATE = subdirs

CONFIG += ordered

new_moc.file = $$PWD/new_moc/new_moc.pro
SUBDIRS += new_moc

before_run.file = $$PWD/before_run/before_run.pro
SUBDIRS += before_run

after_run.file = $$PWD/after_run/after_run.pro
SUBDIRS += after_run

the_run.file = $$PWD/the_run/the_run.pro
SUBDIRS += the_run
\end{lstlisting}          %抄录环境

\begin{lstlisting}[label=f000005,
caption=GoodLuck,
title=\lstlistingname\ \thelstlisting
]
QT -= gui
QT -= core

CONFIG += console

CONFIG(debug,debug|release){
    TARGET = the_run_debug
}else{
    TARGET = the_run
}

TEMPLATE = app

win32-msvc*{
    QMAKE_CXXFLAGS += /std:c++latest
}else{
    CONFIG += c++17
    LIBS += -lstdc++fs
}

SOURCES += $$PWD/main.cpp
DESTDIR =  $$PWD/../bin

DEFINES += QT_DEPRECATED_WARNINGS

#when before build new_moc will call ...
new_moc.dependency_type = TYPE_C
new_moc.variable_out = SOURCES
new_moc.output  = moc_new_${QMAKE_FILE_BASE}.cpp
CONFIG(debug,debug|release){
new_moc.commands = \
$${DESTDIR}/new_moc_debug ${QMAKE_FILE_NAME} ${QMAKE_FILE_OUT}
}else{
new_moc.commands = \
$${DESTDIR}/new_moc ${QMAKE_FILE_NAME} ${QMAKE_FILE_OUT}
}
NEW_MOC_HEADERS = test2.hpp test1.hpp
new_moc.input = NEW_MOC_HEADERS
QMAKE_EXTRA_COMPILERS += new_moc

#when link started before_run will call ...
CONFIG(debug,debug|release){
    QMAKE_PRE_LINK += $${DESTDIR}/before_run_debug $$PWD
}else{
    QMAKE_PRE_LINK += $${DESTDIR}/before_run $$PWD
}
export(QMAKE_PRE_LINK)

#when link finished after_run will call ...
CONFIG(debug,debug|release){
    QMAKE_POST_LINK += $${DESTDIR}/after_run_debug $$PWD
}else{
    QMAKE_POST_LINK += $${DESTDIR}/after_run $$PWD
}
export(QMAKE_POST_LINK)
\end{lstlisting}          %抄录环境

\begin{lstlisting}[label=f00000a,
caption=GoodLuck,
title=\lstlistingname\ \thelstlisting
]
#if __has_include(<filesystem>)
#include <filesystem>
namespace fs = std::filesystem;
#else
#include <experimental/filesystem>
namespace fs = std::experimental::filesystem;
#endif
#include <iostream>

int main(int, char **) {
    std::cout << "the_run" << std::endl;
    return 0;
}
\end{lstlisting}          %抄录环境

\begin{lstlisting}[label=f000006,
caption=GoodLuck,
title=\lstlistingname\ \thelstlisting
]
QT -= gui
QT -= core

CONFIG += console

CONFIG(debug,debug|release){
    TARGET = after_run_debug
}else{
    TARGET = after_run
}

TEMPLATE = app

win32-msvc*{
    QMAKE_CXXFLAGS += /std:c++latest
}else{
    CONFIG += c++17
    LIBS += -lstdc++fs
}

SOURCES += $$PWD/main.cpp
DESTDIR =  $$PWD/../bin

DEFINES += QT_DEPRECATED_WARNINGS
\end{lstlisting}          %抄录环境

\begin{lstlisting}[label=f000007,
caption=GoodLuck,
title=\lstlistingname\ \thelstlisting
]
#if __has_include(<filesystem>)
#include <filesystem>
namespace fs = std::filesystem;
#else
#include <experimental/filesystem>
namespace fs = std::experimental::filesystem;
#endif

#include <iostream>
#include <fstream>
#include <chrono>

class OStream :public std::ofstream {
    using Super = std::ofstream;
public:
    template<typename T,
        typename = std::enable_if_t<
        std::is_constructible_v<Super, T && > > >
        inline OStream(T && arg) :
        Super(std::forward<T>(arg)) {
    }
    template<typename T,
        typename = void,
        typename = std::enable_if_t<
        !std::is_constructible_v<Super, T && > > >
        inline OStream(T && arg) :
        Super(std::forward<T>(arg).string()) {
    }
};

int main(int argc, char ** argv) {
    std::cout << "before_run : "
        << argc << std::endl;
    if (argc < 2) {
        return -1;
    }
    fs::path varPath{ argv[1] };
    OStream stream{ varPath / "after_run.txt" };
    stream << std::chrono::
        high_resolution_clock::now()
        .time_since_epoch().count();
    stream << std::endl;
    return 0;
}
\end{lstlisting}          %抄录环境

\begin{lstlisting}[label=f000008,
caption=GoodLuck,
title=\lstlistingname\ \thelstlisting
]
QT -= gui
QT -= core

CONFIG += console

CONFIG(debug,debug|release){
    TARGET = before_run_debug
}else{
    TARGET = before_run
}

TEMPLATE = app

win32-msvc*{
    QMAKE_CXXFLAGS += /std:c++latest
}else{
    CONFIG += c++17
    LIBS += -lstdc++fs
}

SOURCES += $$PWD/main.cpp
DESTDIR =  $$PWD/../bin

DEFINES += QT_DEPRECATED_WARNINGS
\end{lstlisting}          %抄录环境

\begin{lstlisting}[label=f000009,
caption=GoodLuck,
title=\lstlistingname\ \thelstlisting
]
#if __has_include(<filesystem>)
#include <filesystem>
namespace fs = std::filesystem;
#else
#include <experimental/filesystem>
namespace fs = std::experimental::filesystem;
#endif

#include <iostream>
#include <fstream>
#include <chrono>

class OStream :public std::ofstream {
    using Super = std::ofstream;
public:
    template<typename T,
        typename = std::enable_if_t<
        std::is_constructible_v<Super, T && > > >
        inline OStream(T && arg) :
        Super(std::forward<T>(arg)) {
    }
    template<typename T,
        typename = void,
        typename = std::enable_if_t<
        !std::is_constructible_v<Super, T && > > >
        inline OStream(T && arg) :
        Super(std::forward<T>(arg).string()) {
    }
};

int main(int argc, char ** argv) {
    std::cout << "before_run : "
        << argc << std::endl;
    if (argc < 2) {
        return -1;
    }
    fs::path varPath{ argv[1] };
    OStream stream{ varPath / "before_run.txt" };
    stream << std::chrono::
        high_resolution_clock::now()
        .time_since_epoch().count();
    stream << std::endl;
    return 0;
}
\end{lstlisting}          %抄录环境

\begin{lstlisting}[label=f00000b,
caption=GoodLuck,
title=\lstlistingname\ \thelstlisting
]
QT -= gui
QT -= core

CONFIG += console

CONFIG(debug,debug|release){
    TARGET = new_moc_debug
}else{
    TARGET = new_moc
}

TEMPLATE = app

win32-msvc*{
    QMAKE_CXXFLAGS += /std:c++latest
}else{
    CONFIG += c++17
    LIBS += -lstdc++fs
}

SOURCES += $$PWD/main.cpp
DESTDIR =  $$PWD/../bin

DEFINES += QT_DEPRECATED_WARNINGS
\end{lstlisting}          %抄录环境

\begin{lstlisting}[label=f00000c,
caption=GoodLuck,
title=\lstlistingname\ \thelstlisting
]
#include <iostream>
#include <fstream>

#if __has_include(<filesystem>)
#include <filesystem>
namespace fs = std::filesystem;
#else
#include <experimental/filesystem>
namespace fs = std::experimental::filesystem;
#endif

int main(int argc, char ** argv) {
    std::cout << "new_moc : "
        << argc << std::endl;
    if (argc < 3) {
        return -1;
    }
    std::ifstream varInput{ argv[1] };
    std::ofstream varOutput{ argv[2] };
    varOutput << "/*****************************/";
    varOutput << std::endl;
    varOutput << "#include \"";
    varOutput << argv[1];
    varOutput << "\"";
    varOutput << std::endl;
    varOutput << u8R"(inline static int a = [](){
               std::cout << "Good Luck!" <<std::endl;
               return 12;
               }() ; )";
    varOutput << std::endl;
    return 0;
}
\end{lstlisting}          %抄录环境


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{
qmake杂项
}\label{ss000910}










%使用xelatex编译
%版权所有，翻版必究
%本文件由程序自动生成，任何修改将被覆盖



